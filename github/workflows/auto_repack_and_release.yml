name: Auto Repack M3U â†’ M3U8 + Clean Release (Every 30min, Smart Update)

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  repack:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ§° Prepare environment
        run: |
          mkdir -p m3u8_files
          touch .last_hash

      - name: ðŸ”½ Fetch source playlist
        run: |
          echo "ðŸŒ Downloading source playlist..."
          curl -sL "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/z5.m3u" -o z5.m3u
          if [ ! -s z5.m3u ]; then
            echo "âŒ Failed to download source M3U file."; exit 1
          fi

      - name: ðŸ” Check if z5.m3u changed
        id: check_change
        run: |
          current_hash=$(sha256sum z5.m3u | awk '{print $1}')
          last_hash=$(cat .last_hash 2>/dev/null || echo "none")

          if [ "$current_hash" = "$last_hash" ]; then
            echo "nochange=true" >> $GITHUB_ENV
            echo "ðŸŸ¡ No change detected in z5.m3u, skipping repack."
          else
            echo "$current_hash" > .last_hash
            echo "nochange=false" >> $GITHUB_ENV
            echo "âœ… Detected new changes in z5.m3u."
          fi

      - name: ðŸ§© Repack M3U â†’ M3U8
        if: env.nochange == 'false'
        run: |
          input_m3u="z5.m3u"
          output_dir="m3u8_files"
          combine_output="Zee5_Live_All.m3u8"
          user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 ygx/69.1 Safari/537.36"

          echo "ðŸ” Reading $input_m3u ..."
          > "$combine_output"

          while IFS= read -r line; do
            if [[ $line == \#EXTINF* ]]; then
              channel_name=$(echo "$line" | sed -E 's/.*,(.*)$/\1/')
              file_name=$(echo "$channel_name" | tr -dc '[:alnum:]_-' | sed 's/ /_/g').m3u8
              current_extinf="$line"
            elif [[ $line == http* ]]; then
              stream_url="$line"

              {
                echo "#EXTM3U"
                echo "$current_extinf"
                echo "#EXTVLCOPT:http-user-agent=$user_agent"
                echo "#KODIPROP:inputstream.adaptive.manifest_type=hls"
                echo "#KODIPROP:inputstream.adaptive.stream_selection_type=adaptive"
                echo "#KODIPROP:inputstream.adaptive.license_type=clearkey"
                echo "$stream_url"
              } > "$output_dir/$file_name"

              {
                echo "$current_extinf"
                echo "#EXTVLCOPT:http-user-agent=$user_agent"
                echo "#KODIPROP:inputstream.adaptive.manifest_type=hls"
                echo "#KODIPROP:inputstream.adaptive.stream_selection_type=adaptive"
                echo "#KODIPROP:inputstream.adaptive.license_type=clearkey"
                echo "$stream_url"
              } >> "$combine_output"

              echo "âœ… Created: $output_dir/$file_name"
            fi
          done < "$input_m3u"

          echo "ðŸŽ‰ Repacking complete."

      - name: ðŸ“¤ Commit repacked files
        if: env.nochange == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add m3u8_files/ Zee5_Live_All.m3u8 .last_hash
          git commit -m "ðŸŽ¬ Auto repack M3U to M3U8 @ $(TZ='Asia/Dhaka' date '+%Y-%m-%d %H:%M:%S')" || echo "ðŸŸ¡ No changes"
          git push

      - name: ðŸ§¹ Delete old releases & tags
        if: env.nochange == 'false'
        run: |
          echo "ðŸ§¹ Cleaning up old releases..."
          releases=$(gh release list --limit 100 | awk '{print $1}' | tail -n +2)
          for tag in $releases; do
            if [ "$tag" != "latest" ]; then
              echo "Deleting old release: $tag"
              gh release delete "$tag" -y || true
              git push --delete origin "$tag" || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Create or Update Latest Release
        if: env.nochange == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Auto Updated Zee5 M3U8 Playlist"
          files: |
            Zee5_Live_All.m3u8
          body: |
            ðŸŽ¬ **Auto-updated Zee5 playlist**

            âœ… Generated: $(TZ='Asia/Dhaka' date '+%Y-%m-%d %H:%M:%S')

            Use this permanent link in any player:
            ```
            https://github.com/${{ github.repository }}/releases/latest/download/Zee5_Live_All.m3u8
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ’¤ Skip summary
        if: env.nochange == 'true'
        run: echo "ðŸŸ¡ Skipped run â€” no update in z5.m3u"
