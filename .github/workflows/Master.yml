name: Shivansh Master Playlist

on:
  schedule:
    - cron: "*/15 * * * *"   # Runs every 15 minutes
  workflow_dispatch:

concurrency:
  group: shivansh-m3u
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Normalize sources.txt
        run: dos2unix sources.txt || true

      - name: Combine M3U files
        id: combine
        shell: bash
        run: |
          TIME_IST=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")

          # Initialize M3U file with header
          {
            echo '#EXTM3U billed-msg="Join Telegram @ ShivanshPlaylists"'
            echo '# Pushed and Updated by Shivansh'
            echo '# Coded & Scripted by Kittujk'
            echo "# Last updated: $TIME_IST"
          } > Shivansh.m3u

          echo "Merging playlists from $(wc -l < sources.txt) sources..."
          cat sources.txt

          # Merge playlists cleanly
          while IFS= read -r url; do
            url="${url%%#*}"                      # Strip comments
            url="$(echo -n "$url" | tr -d '\r')"  # Clean CR
            if [ -n "$url" ]; then
              echo "Fetching: $url"
              curl -sL --max-time 30 --retry 3 --retry-delay 5 "$url" >> Shivansh.m3u
              echo "" >> Shivansh.m3u
            fi
          done < sources.txt

          # Count total channels
          CHANNEL_COUNT=$(grep -c '^#EXTINF' Shivansh.m3u || true)

          {
            echo ""
            echo "# ---- Created Exclusively for Shivansh Playlists ----"
            echo "# Total Channels: $CHANNEL_COUNT"
            echo "# Last Updated: $TIME_IST"
          } >> Shivansh.m3u

          echo "âœ… Total Channels Found: $CHANNEL_COUNT"
          echo "âœ… Playlist Updated at: $TIME_IST"

          # Export outputs for commit message
          echo "count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT
          echo "time=$TIME_IST" >> $GITHUB_OUTPUT

      - name: Show output size
        run: ls -lh Shivansh.m3u || true

      - name: Commit and push changes
        shell: bash
        env:
          GIT_AUTHOR_NAME: "GitHub Actions Bot"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          git add Shivansh.m3u
          if ! git diff --quiet --cached; then
            git commit -m "Auto-update Shivansh.m3u [${{ steps.combine.outputs.time }}] | Channels: ${{ steps.combine.outputs.count }}"
            
            # ðŸ§  Ensure latest main branch to prevent push conflicts
            git pull --rebase origin main || true

            # âœ… Push changes safely
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "No changes to Shivansh.m3u"
          fi
