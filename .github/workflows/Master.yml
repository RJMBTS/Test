name: Shivansh Master Playlist Builder

on:
  schedule:
    - cron: '*/15 * * * *'  # Runs every 15 minutes
  workflow_dispatch:         # Allows manual trigger from GitHub

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Combine and clean M3U playlists with custom header
        run: |
          set -e
          OUTPUT="Shivansh.m3u"
          TEMP="temp_combined.m3u"
          TEMP_CLEAN="temp_clean.m3u"
          LOG_FILE="shivansh-log.txt"

          echo "üîÑ Starting Shivansh Master Playlist Builder..."
          echo "Run started at: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')" > "$LOG_FILE"

          # Ensure sources.txt exists
          if [ ! -f sources.txt ]; then
            echo "‚ùå sources.txt not found!" | tee -a "$LOG_FILE"
            echo "#EXTM3U billed-msg=\"Join our Telegram @ Shivanshplaylists\"" > "$OUTPUT"
            echo "# No sources found." >> "$OUTPUT"
            exit 0
          fi

          echo "#EXTM3U" > "$TEMP"

          echo "üîç Reading URLs from sources.txt..." | tee -a "$LOG_FILE"
          while IFS= read -r url; do
            if [ -z "$url" ]; then
              continue
            fi
            if [[ "$url" == *.m3u* ]]; then
              echo "‚ñ∂Ô∏è Fetching: $url" | tee -a "$LOG_FILE"
              {
                echo ""
                echo "# --- Begin: $url ---"
                if curl -fsSL --max-time 30 "$url" >> "$TEMP"; then
                  echo "‚úÖ Success: $url" | tee -a "$LOG_FILE"
                else
                  echo "# Failed to fetch: $url" >> "$TEMP"
                  echo "‚ùå Failed: $url" | tee -a "$LOG_FILE"
                fi
                echo "# --- End: $url ---"
              } >> "$TEMP"
            else
              echo "‚ö†Ô∏è Skipping non-M3U URL: $url" | tee -a "$LOG_FILE"
            fi
          done < sources.txt

          # If no playlist data fetched, still create a valid M3U
          if ! grep -q "#EXTINF" "$TEMP"; then
            echo "‚ö†Ô∏è No valid channels found. Creating empty playlist." | tee -a "$LOG_FILE"
            echo "#EXTM3U billed-msg=\"Join our Telegram @ Shivanshplaylists\"" > "$OUTPUT"
            echo "# No channels fetched from provided sources." >> "$OUTPUT"
            exit 0
          fi

          echo "üßπ Removing duplicates..."
          awk '!seen[$0]++' "$TEMP" > "$TEMP_CLEAN"

          TOTAL_CHANNELS=$(grep -c '^#EXTINF' "$TEMP_CLEAN" || echo "0")
          LAST_UPDATED=$(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')

          echo "üß† Writing final file header..."
          {
            echo '#EXTM3U billed-msg="Join our Telegram @ Shivanshplaylists"'
            echo "# Pushed & Updated by : Shivansh"
            echo "# Coded & Supported by: Kittujk"
            echo "# Total Channels: $TOTAL_CHANNELS"
            echo "# Last Updated: $LAST_UPDATED"
            echo ""
            cat "$TEMP_CLEAN"
          } > "$OUTPUT"

          echo "‚úÖ Playlist built successfully: $OUTPUT"
          echo "üì∫ Total Channels: $TOTAL_CHANNELS"
          echo "üïí Last Updated: $LAST_UPDATED"
          echo "‚úÖ Log saved to $LOG_FILE"

          rm -f "$TEMP" "$TEMP_CLEAN"

      - name: Commit and push updates
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add Shivansh.m3u shivansh-log.txt
          git diff --quiet && echo "No changes to commit" || (
            git commit -m "Auto-update Shivansh Master Playlist"
            git push origin main
          )
