name: Shivansh Master Playlist Builder

on:
  schedule:
    - cron: '*/15 * * * *'   # Runs every 15 minutes
  workflow_dispatch:         # Allows manual trigger

concurrency:
  group: shivansh-master
  cancel-in-progress: false  # ‚úÖ allow current run to finish safely

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Shivansh.m3u from sources.txt
        run: |
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)
          sources_file="sources.txt"

          if [ ! -f "$sources_file" ]; then
            echo "‚ùå sources.txt not found in repository root."
            exit 1
          fi

          echo "üîπ Starting Shivansh.m3u build at $timestamp"
          echo "üìú Reading URLs from $sources_file"
          grep -v '^#' "$sources_file" | grep -v '^$' > "$tmpdir/urls.txt"

          {
            echo '#EXTM3U billed-msg="RJM Tv - RJMBTS Network"'
            echo "# Playlist Maintained by RJMBTS"
            echo "# Builder: Shivansh Master Playlist Builder"
            echo "# Source file: sources.txt"
            echo "# Last updated: $timestamp"
          } > Shivansh.m3u

          echo "üåê Fetching all M3U sources in parallel..."

          i=0
          while read -r url; do
            [[ -z "$url" ]] && continue
            i=$((i+1))
            {
              if curl -fs --retry 3 --max-time 15 "$url" | grep -v -E '^#EXTM3U|# Pushed and updated by|# Join Telegram' > "$tmpdir/part_$i.m3u"; then
                echo "‚úÖ Added: $url"
              else
                echo "‚ö†Ô∏è Failed: $url"
                echo "# ‚ö†Ô∏è Failed to fetch: $url" > "$tmpdir/part_$i.m3u"
              fi
            } &
          done < "$tmpdir/urls.txt"

          # Wait for all background jobs
          wait
          echo "‚úÖ All sources fetched. Combining into Shivansh.m3u..."

          for part in $(ls -v "$tmpdir"/part_*.m3u 2>/dev/null); do
            echo "" >> Shivansh.m3u
            cat "$part" >> Shivansh.m3u
          done

          # Validate final output
          if [ ! -s Shivansh.m3u ]; then
            echo "‚ùå Shivansh.m3u is empty. Build aborted."
            exit 1
          fi

          echo "‚úÖ Shivansh.m3u built successfully at $timestamp."

      - name: Commit and push updated Shivansh.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add Shivansh.m3u
          
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update Shivansh.m3u"
            
            # ‚úÖ Pull before push (avoid conflicts)
            git pull --rebase origin main || true

            # ‚úÖ Push with retry
            n=0
            until [ "$n" -ge 3 ]
            do
              git push origin main && break
              n=$((n+1))
              echo "‚ö†Ô∏è Push failed, retrying in 10s... ($n/3)"
              sleep 10
            done
          else
            echo "No changes detected ‚Äî skipping commit."
          fi

      - name: Summary
        run: |
          echo "‚úÖ Shivansh.m3u updated successfully at $(date)"
