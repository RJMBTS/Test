name: Shivansh Master Playlist

on:
  schedule:
    - cron: "*/15 * * * *"  # Runs every 15 minutes
  workflow_dispatch:

concurrency:
  group: shivansh-m3u
  cancel-in-progress: false  # âœ… Queue new jobs instead of canceling in-progress ones

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ§© Normalize sources.txt
      - name: Normalize sources.txt
        run: dos2unix sources.txt || true

      # ğŸ§© Combine and generate M3U playlist
      - name: Combine M3U files
        id: combine
        shell: bash
        run: |
          set -euo pipefail

          TIME_IST=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
          TMP_FILE="Shivansh_temp.m3u"
          > "$TMP_FILE"

          echo "ğŸ•’ Starting merge at $TIME_IST"
          echo "ğŸ“¦ Sources loaded: $(wc -l < sources.txt)"

          # Random short delay (helps avoid conflicts if multiple repos trigger)
          sleep $((RANDOM % 60))

          # Fetch and merge all URLs
          while IFS= read -r url; do
            url="${url%%#*}"
            url="$(echo -n "$url" | tr -d '\r')"
            [ -z "$url" ] && continue

            echo "ğŸ”— Fetching: $url"
            if curl -sL --max-time 30 --retry 3 --retry-delay 5 "$url" | grep -q "#EXTM3U"; then
              curl -sL "$url" >> "$TMP_FILE"
              echo "" >> "$TMP_FILE"
            else
              echo "âš ï¸ Invalid or empty M3U: $url" >> invalid_sources.log
            fi
          done < sources.txt

          # Replace YGX branding with Shivansh
          sed -i -E 's|tvg-logo="[^"]*",by *@[Yy]gxworld|tvg-logo="https://t.me/ShivanshPlaylists",by @Shivansh|g' "$TMP_FILE"

          # Count channels
          TOTAL_CHANNELS=$(grep -c '^#EXTINF' "$TMP_FILE" || true)
          UPDATED_CHANNELS=$TOTAL_CHANNELS

          # ğŸ§¾ Create header
          {
            echo '#EXTM3U billed-msg="Join Telegram @ShivanshPlaylists"'
            echo '# ---------------------------------------------'
            echo '# ğŸ”¹ $P Exclusive (Shivansh) ğŸ”¹'
            echo '# Pushed & Updated by Shivansh'
            echo '# Coded & Scripted by Kittujk'
            echo "# Last updated: $TIME_IST"
            echo "# Channels: Total - $TOTAL_CHANNELS | Updated - $UPDATED_CHANNELS"
            echo '# ---------------------------------------------'
            echo ""
          } > Shivansh.m3u

          # Append merged content and footer
          cat "$TMP_FILE" >> Shivansh.m3u
          echo "# ---- Created Exclusively for Shivansh Playlists ----" >> Shivansh.m3u
          echo "" >> Shivansh.m3u

          echo "âœ… Total Channels Found: $TOTAL_CHANNELS"
          echo "âœ… Playlist Updated at: $TIME_IST"

          # Export summary for commit message
          echo "count=$TOTAL_CHANNELS" >> $GITHUB_OUTPUT
          echo "time=$TIME_IST" >> $GITHUB_OUTPUT

      # ğŸ§¾ Show output info and invalid source list (if any)
      - name: Show output details
        run: |
          du -h Shivansh.m3u || true
          if [ -f invalid_sources.log ]; then
            echo "âš ï¸ Invalid Sources Found:"
            cat invalid_sources.log
          else
            echo "âœ… All sources valid."
          fi

      # ğŸ’¾ Upload playlist artifact (v4)
      - name: Upload Shivansh.m3u artifact
        uses: actions/upload-artifact@v4
        with:
          name: Shivansh-Playlist
          path: Shivansh.m3u

      # ğŸ§  Commit and push if changed
      - name: Commit and push changes
        shell: bash
        env:
          GIT_AUTHOR_NAME: "GitHub Actions Bot"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          git add Shivansh.m3u || true

          if ! git diff --quiet --cached; then
            echo "ğŸ“œ Committing updated playlist..."
            git commit -m "Auto-update Shivansh.m3u [${{ steps.combine.outputs.time }}] | Channels: ${{ steps.combine.outputs.count }}"

            # Ensure branch sync before push
            git pull --rebase origin main || true

            # Push changes using GitHub Token
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          else
            echo "â„¹ï¸ No changes detected in Shivansh.m3u"
          fi
