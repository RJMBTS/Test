name: Shivansh Master Playlist Builder

on:
  schedule:
    - cron: '*/15 * * * *'   # Runs every 15 minutes
  workflow_dispatch:         # Manual trigger option

concurrency:
  group: shivansh-m3u
  cancel-in-progress: false   # Allow current run to finish safely

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10       # Prevent infinite hang

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Shivansh.m3u (clean + sorted + channel count)
        run: |
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)
          trap 'rm -rf "$tmpdir"' EXIT

          echo "üîπ Starting M3U combination at $timestamp"

          if [ ! -f sources.txt ]; then
            echo "‚ùå sources.txt not found. Exiting."
            exit 1
          fi

          grep -v '^$' sources.txt > "$tmpdir/sources.txt"
          if [ ! -s "$tmpdir/sources.txt" ]; then
            echo "‚ùå sources.txt is empty. Exiting."
            exit 1
          fi

          echo "üåê Fetching M3U sources..."

          i=0
          max_jobs=10
          while read -r url; do
            [[ -z "$url" ]] && continue
            i=$((i+1))
            {
              if curl -fs "$url" | grep -v -E '^#EXTM3U|# Pushed and updated by|# Join Telegram' > "$tmpdir/part_$i.m3u"; then
                echo "‚úÖ Added: $url"
              else
                echo "‚ö†Ô∏è Failed: $url"
                echo "# ‚ö†Ô∏è Failed to fetch: $url" > "$tmpdir/part_$i.m3u"
              fi
            } &
            ((i % max_jobs == 0)) && wait
          done < "$tmpdir/sources.txt"
          wait

          echo "‚úÖ All sources fetched. Combining files..."
          cat "$tmpdir"/part_*.m3u > "$tmpdir/combined.m3u"

          # üßπ Remove duplicates by URL
          echo "üßπ Removing duplicate channels..."
          awk -v extinf="$tmpdir/uniq_extinf.txt" -v urls="$tmpdir/uniq_urls.txt" '
            /^#EXTINF/ {info=$0; next}
            /^http/ {
              url=$0
              if (!seen[url]++) {
                print info >> extinf
                print url >> urls
              }
            }
          ' "$tmpdir/combined.m3u"

          if [ ! -s "$tmpdir/uniq_extinf.txt" ]; then
            echo "‚ùå No valid channels found after duplicate removal."
            exit 0
          fi

          paste -d'\n' "$tmpdir/uniq_extinf.txt" "$tmpdir/uniq_urls.txt" > "$tmpdir/cleaned.m3u"

          # üî§ Sort alphabetically by channel name
          echo "üî§ Sorting channels alphabetically..."
          awk '
            /^#EXTINF/ {info=$0; getline url; print info "|" url}
          ' "$tmpdir/cleaned.m3u" | sort -t',' -k2,2 | tr '|' '\n' > "$tmpdir/sorted.m3u"

          # üßÆ Count total channels
          total_channels=$(grep -c '^#EXTINF' "$tmpdir/sorted.m3u")

          # üßæ Build final Shivansh.m3u with header
          {
            echo '#EXTM3U billed-msg="Join our Telegram @ Shivanshplaylists"'
            echo "# Pushed & Updated by : Shivansh"
            echo "# Coded & Supported by: Kittujk"
            echo "# Total Channels: $total_channels"
            echo "# Last Updated: $timestamp"
            echo ""
            cat "$tmpdir/sorted.m3u"
          } > Shivansh.m3u

          if [ ! -s Shivansh.m3u ]; then
            echo "‚ùå Shivansh.m3u is empty after processing. Exiting."
            exit 0
          fi

          echo "‚úÖ Shivansh.m3u built successfully with $total_channels channels."

          # üß† Write or update run summary log safely
          touch shivansh-log.txt
          echo "[$timestamp] ‚úÖ Updated Shivansh.m3u ‚Äî $total_channels channels" >> shivansh-log.txt

      - name: Commit and push Shivansh.m3u and log
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Safely stage files (ignore if log missing)
          git add -f Shivansh.m3u shivansh-log.txt 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update Shivansh.m3u ($total_channels channels)"
            
            git pull --rebase origin main || true

            n=0
            until [ "$n" -ge 3 ]
            do
              git push origin main && break
              n=$((n+1))
              echo "‚ö†Ô∏è Push failed, retrying in 10s... ($n/3)"
              sleep 10
            done
          else
            echo "No changes detected ‚Äî skipping commit."
          fi

      - name: Summary
        run: |
          echo "‚úÖ Shivansh.m3u updated at $(date)"
