name: STGLOC Auto Builder ðŸŒ

on:
  schedule:
    - cron: "*/30 * * * *"    # â° Auto runs every 30 minutes
  workflow_dispatch:

concurrency:
  group: stgloc-pipeline
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # STEP 1ï¸âƒ£: Build master stgloc.m3u
      - name: ðŸ§© Build master stgloc.m3u
        id: build
        run: |
          set -euxo pipefail
          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)
          src="https://raw.githubusercontent.com/RJMBTS/Tlcp/refs/heads/main/scpl.m3u"

          echo "ðŸ”¹ Building STGLOC master M3U at $timestamp"
          curl -fSL --max-time 60 "$src" -o "$tmpdir/source.m3u"

          {
            echo "# ðŸ”¹ Auto Updated by RJMBTS"
            echo "# ðŸ”¸ Maintained by STGLOC Network"
            echo "# ðŸ•’ Last updated: $timestamp"
            echo ""
            echo '#EXTM3U billed-msg="STGLOC Network - RJMBTS Automation"'
            echo ""
          } > stgloc.m3u

          echo "ðŸŽ¯ Cleaning and converting URLs..."
          grep -v '^#EXTM3U' "$tmpdir/source.m3u" > "$tmpdir/source_clean.m3u" || true
          sed -i -E '/^https?:\/\//s#($|\?.*)#.m3u8#' "$tmpdir/source_clean.m3u"

          echo "ðŸ§¹ Deduplicating and numbering channels..."
          awk '
            BEGIN { ch=0 }
            /^#EXTINF/ {
              info=$0
              getline url
              if (url == "") next
              gsub(/[[:space:]]+$/, "", url)
              if (!(info in seen_info) && !(url in seen_url)) {
                seen_info[info]=1
                seen_url[url]=1
                ch++
                if (info !~ /tvg-chno=/) {
                  sub(/^#EXTINF:-1/, sprintf("#EXTINF:-1 tvg-chno=\"%d\"", ch), info)
                }
                print info
                print url
              }
            }
          ' "$tmpdir/source_clean.m3u" >> stgloc.m3u

          total=$(grep -c '^#EXTINF' stgloc.m3u || echo 0)
          echo "total=$total" >> $GITHUB_OUTPUT
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          echo "âœ… Master playlist built â€” $total channels."

      # STEP 2ï¸âƒ£: Generate individual .m3u8 files
      - name: ðŸ§© Generate per-channel .m3u8 files
        id: split
        run: |
          set -euxo pipefail
          echo "ðŸŽ¯ Generating .m3u8 files from stgloc.m3u ..."
          find . -maxdepth 1 -type f -name "*.m3u8" -delete || true

          awk '
            /^#EXTINF/ {
              info=$0
              getline url
              if (url ~ /^https?:\/\//) {
                name=info
                sub(/.*tvg-name="/, "", name)
                sub(/".*/, "", name)
                if (name == "") { name=info; sub(/.*,/, "", name) }
                gsub(/[[:space:]]+/, "_", name)
                gsub(/[^A-Za-z0-9_.-]/, "", name)
                if (name == "") name="unknown"
                if (url !~ /\.m3u8$/) url=url".m3u8"
                file=sprintf("%s.m3u8", name)
                print "#EXTM3U" > file
                print info >> file
                print url >> file
                close(file)
                print "âœ… Created: " file
              }
            }
          ' stgloc.m3u

          count=$(ls *.m3u8 2>/dev/null | wc -l || echo 0)
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "âœ… $count individual .m3u8 files created."

      # STEP 3ï¸âƒ£: Commit and push updates
      - name: ðŸš€ Commit & Push (STGLOC Auto)
        run: |
          set -euxo pipefail
          git config user.name "STGLOC Auto Builder"
          git config user.email "actions@github.com"
          git add stgloc.m3u *.m3u8 || true
          if git diff --cached --quiet; then
            echo "No new updates â€” skipping commit."
          else
            git commit -m "ðŸ”„ Auto-update STGLOC master + .m3u8 files"
            git pull --rebase origin main || git rebase --abort
            git push origin main || echo "âš ï¸ Push failed, build succeeded."
          fi

      # STEP 4ï¸âƒ£: Trigger Vercel rebuild (optional)
      - name: ðŸ” Trigger Vercel Deployment
        if: success() && env.DEPLOY_HOOK != ''
        env:
          DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          echo "ðŸš€ Triggering Vercel rebuild for STGLOC..."
          curl -X POST "$DEPLOY_HOOK" -H "Accept: application/json"

      # STEP 5ï¸âƒ£: Post summary to GitHub Actions UI
      - name: ðŸ§¾ Build Summary
        run: |
          echo "## ðŸŒ STGLOC Auto Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------:|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“º Total channels in stgloc.m3u | ${{ steps.build.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¬ Individual .m3u8 files created | ${{ steps.split.outputs.count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ•’ **Last updated:** ${{ steps.build.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”¸ **Deployed at:** [nrtv.vercel.app](https://nrtv.vercel.app)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”¹ **Maintained by:** [@RJMBTS](https://github.com/RJMBTS)" >> $GITHUB_STEP_SUMMARY
